import{r as v,j as e,m as M,ae as lt,s as ct,q as Ge,F as Be,B as ze,A as ue,l as pe,T as Se,n as ce,D as Ee,v as Te,C as dt,af as Je,ag as Qe,ah as We,ai as mt,V as ut,$ as ht,aj as qe,X as fe,t as xt,f as Le,k as pt,ak as ft,ad as gt,P as He,a9 as bt,a4 as be,a7 as yt,E as xe,aa as ye,a2 as he,al as vt}from"./chunk-K5sxpyAn.js";import{C as Me,h as Ae,j as Pe,S as wt,a as kt,b as jt,c as Nt,d as Ct,T as St,e as Tt,f as ve,g as we}from"./chunk-D5hk64dV.js";import{g as V,b as re,A as Lt,s as Et,B as z,d as Mt,u as Ie,t as ke,v as At,e as Pt,w as It}from"./index-BMfWBLPx.js";import{P as Ze}from"./chunk-CZpVelb_.js";import{S as Ot}from"./chunk-C8_VK1iL.js";import"./chunk-DxddZhsK.js";const Ue=({step:d,isActive:r=!1,isCompleted:s=!1,onClick:l,compact:n=!1,showConnector:m=!1,connectorStatus:f="pending",className:y=""})=>{const[g,o]=v.useState(!1),c=_=>{switch(_){case"pending":return pe;case"active":return Ee;case"completed":return ce;case"failed":return ze;case"waiting":return pe;case"skipped":return Se;default:return pe}},b=_=>{switch(_){case"completed":return"bg-emerald-500";case"active":return"bg-blue-500";default:return"bg-slate-300 dark:bg-slate-600"}},F=(_,Y)=>{if(!_)return null;const K=new Date(_),x=Y?new Date(Y):new Date,D=Math.floor((x.getTime()-K.getTime())/1e3);return D<60?`${D}s`:D<3600?`${Math.floor(D/60)}m ${D%60}s`:`${Math.floor(D/3600)}h ${Math.floor(D%3600/60)}m`},R=_=>{if(!_||_.length===0)return null;const Y=_[_.length-1];return Y.message.length>60?`${Y.message.substring(0,60)}...`:Y.message},A=c(d.status),N=F(d.startTime,d.endTime),k=R(d.logs),P=d.logs&&d.logs.length>0,Q={idle:{scale:1,boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1)"},hover:{scale:1.02,boxShadow:"0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",transition:{duration:.2}},active:{scale:1.01,boxShadow:"0 0 0 2px rgba(59, 130, 246, 0.5)"}},I={collapsed:{height:0,opacity:0},expanded:{height:"auto",opacity:1}},H={duration:.3,ease:[.4,0,.2,1]},Z=d.status==="active"||r,X=d.status==="completed"||s,J=d.status==="failed";return n?e.jsx("div",{className:"relative",children:e.jsxs(M.div,{className:`
            relative p-3 rounded-2xl border cursor-pointer
            ${Z?"border-blue-500 bg-blue-500/5":X?"border-emerald-500 bg-emerald-500/5":J?"border-rose-500 bg-rose-500/5":"border-slate-200 dark:border-slate-700"}
            ${y}
          `,variants:Q,initial:"idle",animate:Z?"active":"idle",whileHover:l?"hover":void 0,onClick:l,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:`w-4 h-4 ${X?"text-emerald-500":Z?"text-blue-500":J?"text-rose-500":"text-slate-400"}`}),e.jsx("span",{className:`text-sm font-medium ${Z?"text-blue-600 dark:text-blue-400":X?"text-emerald-600 dark:text-emerald-400":J?"text-rose-600 dark:text-rose-400":"text-slate-600 dark:text-slate-300"}`,children:d.name})]}),d.progress!==void 0&&d.progress>0&&e.jsx("div",{className:"mt-2",children:e.jsx(Ze,{value:d.progress,className:"h-1"})})]})}):e.jsxs("div",{className:"relative",children:[e.jsx(M.div,{variants:Q,initial:"idle",animate:Z?"active":"idle",whileHover:l?"hover":void 0,children:e.jsxs(Me,{className:`rounded-2xl border-2 transition-all duration-300 ${Z?"border-blue-500 shadow-blue-500/20":X?"border-emerald-500 shadow-emerald-500/20":J?"border-rose-500 shadow-rose-500/20":"border-slate-200 dark:border-slate-700"} ${y}`,children:[e.jsxs(Ae,{className:`pb-3 ${l?"cursor-pointer":""}`,onClick:l,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(M.div,{animate:Z?{rotate:360}:{rotate:0},transition:Z?{duration:2,repeat:1/0,ease:"linear"}:void 0,children:e.jsx(A,{className:`w-5 h-5 ${X?"text-emerald-500":Z?"text-blue-500":J?"text-rose-500":"text-slate-400"}`})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:d.name}),N&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-slate-500",children:[e.jsx(lt,{className:"w-3 h-3"}),e.jsx("span",{children:N})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ot,{status:d.status,size:"sm",animate:r}),P&&e.jsx(V,{variant:"ghost",size:"sm",onClick:_=>{_.stopPropagation(),o(!g)},className:"p-1 h-auto",children:g?e.jsx(ct,{className:"w-4 h-4"}):e.jsx(Ge,{className:"w-4 h-4"})})]})]}),d.status==="active"&&d.progress!==void 0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex justify-between text-sm text-slate-500 mb-1",children:[e.jsx("span",{children:"Progress"}),e.jsxs("span",{children:[Math.round(d.progress),"%"]})]}),e.jsx(Ze,{value:d.progress,className:"h-2"})]}),k&&!g&&e.jsx("div",{className:"mt-3 p-2 bg-slate-50 dark:bg-slate-800 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Be,{className:"w-4 h-4 text-slate-400 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-300 font-mono",children:k})]})}),d.error&&e.jsx("div",{className:"mt-3 p-3 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ze,{className:"w-4 h-4 text-rose-500 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-rose-700 dark:text-rose-300",children:d.error})]})})]}),e.jsx(ue,{children:g&&P&&e.jsx(M.div,{variants:I,initial:"collapsed",animate:"expanded",exit:"collapsed",transition:H,className:"overflow-hidden",children:e.jsx(Pe,{className:"pt-0",children:e.jsxs("div",{className:"border-t border-slate-200 dark:border-slate-700 pt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Be,{className:"w-4 h-4 text-slate-500"}),e.jsxs("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:["Logs (",d.logs.length,")"]})]}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:d.logs.slice(-10).map((_,Y)=>e.jsx("div",{className:"p-2 bg-slate-50 dark:bg-slate-800 rounded text-xs font-mono",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-slate-400 flex-shrink-0",children:new Date(_.timestamp).toLocaleTimeString()}),e.jsx("span",{className:`flex-shrink-0 uppercase font-semibold ${_.level==="error"?"text-rose-500":_.level==="warn"?"text-amber-500":_.level==="info"?"text-blue-500":"text-slate-500"}`,children:_.level}),e.jsx("span",{className:"text-slate-700 dark:text-slate-300",children:_.message})]})},Y))}),d.logs.length>10&&e.jsx("div",{className:"mt-2 text-center",children:e.jsxs(V,{variant:"ghost",size:"sm",className:"text-xs",children:["View all ",d.logs.length," logs"]})})]})})})})]})}),m&&e.jsx("div",{className:"absolute left-6 top-full w-0.5 h-4 -mt-1",children:e.jsx(M.div,{className:`w-full h-full ${b(f)}`,initial:{scaleY:0},animate:{scaleY:1},transition:{duration:.5,delay:.2}})})]})},Ve=["planning","extraction","validation","merge","inventory","pricing","supplier","logistics","finance","confirmation","payment","order","blockchain","email"],je={OrderExtractionTool:"extraction",ValidatorTool:"validation","Merge Fields Tool":"merge","Inventory Check Tool":"inventory","Pricing Calculator":"pricing","Supplier Quote Tool":"supplier",LogisticsShippingTool:"logistics",FinanceAndPaymentTool:"finance",ClarificationTool:"confirmation",StripePaymentTool:"payment","Order Tool":"order","Blockchain Anchor Tool":"blockchain","Portia Google Send Email Tool":"email",order_extraction_tool:"extraction",orderextractiontool:"extraction","order extraction":"extraction",validator_tool:"validation",validatortool:"validation",merge_fields_tool:"merge",mergefields:"merge",inventory_tool:"inventory",inventorycheck:"inventory",pricing_tool:"pricing",pricingcalculator:"pricing",supplier_tool:"supplier",supplierquote:"supplier",logistics_tool:"logistics",logisticsshipping:"logistics",finance_tool:"finance",financeandpayment:"finance",clarification_tool:"confirmation",clarificationtool:"confirmation",stripe_payment_tool:"payment",stripepayment:"payment",order_tool:"order",ordertool:"order",blockchain_anchor:"blockchain",blockchainanchor:"blockchain",email:"email",emailtool:"email",planning:"planning",plan:"planning","plan generated":"planning"},Oe=({steps:d,currentStep:r,orientation:s="vertical",onStepClick:l,className:n=""})=>{if(!Array.isArray(d))return e.jsx("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-red-600",children:"Error: Invalid steps data"})});if(d.length===0)return e.jsx("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsx("p",{className:"text-yellow-600",children:"No workflow steps available"})});const m=Te.useMemo(()=>{if(d.length>0){const o=new Map,c=new Map,b=new Map;d.forEach(N=>{o.set(N.id.toLowerCase(),N),N.toolName&&c.set(N.toolName.toLowerCase(),N),N.name&&b.set(N.name.toLowerCase(),N);const k=je[N.id.toLowerCase()];if(k&&k!==N.id.toLowerCase()&&o.set(k,N),N.toolName){const P=je[N.toolName.toLowerCase()];P&&o.set(P,N)}});const F=[];Ve.forEach(N=>{let k;k=o.get(N),k||(k=Array.from(c.values()).find(P=>(P.toolName?je[P.toolName.toLowerCase()]:null)===N)),k||(k=Array.from(b.values()).find(P=>P.name?.toLowerCase().includes(N)||N.includes(P.name?.toLowerCase()||""))),k||(k=d.find(P=>{const Q=P.id.toLowerCase(),I=P.name?.toLowerCase()||"",H=P.toolName?.toLowerCase()||"";return Q.includes(N)||I.includes(N)||H.includes(N)||N.includes(Q)})),k&&F.push(k)});const R=new Set(F.map(N=>N.id)),A=d.filter(N=>!R.has(N.id));return A.length>0&&F.push(...A),F}return Ve.map(o=>({id:o,name:o.charAt(0).toUpperCase()+o.slice(1),status:"pending",logs:[],progress:0}))},[d]);r&&(o=>m.findIndex(c=>c.id===o))(r);const y={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1,delayChildren:.2}}},g={hidden:{opacity:0,y:s==="vertical"?20:0,x:s==="horizontal"?20:0},visible:{opacity:1,y:0,x:0,transition:{type:"spring",stiffness:300,damping:30}}};return s==="horizontal"?e.jsx(M.div,{className:`flex items-center gap-4 overflow-x-auto pb-4 ${n}`,variants:y,initial:"hidden",animate:"visible",children:m.map((o,c)=>e.jsxs(Te.Fragment,{children:[e.jsx(M.div,{variants:g,className:"flex-shrink-0",children:e.jsx(Ue,{step:o,isActive:o.status==="active",isCompleted:o.status==="completed",onClick:l?()=>l(o.id):void 0,compact:!0})}),c<m.length-1&&e.jsx(M.div,{variants:g,className:"flex-shrink-0",children:e.jsx(dt,{className:`w-5 h-5 transition-colors duration-300 ${o.status==="completed"?"text-emerald-500":"text-slate-400"}`})})]},o.id))}):e.jsx(M.div,{className:`space-y-4 ${n}`,variants:y,initial:"hidden",animate:"visible",children:m.map((o,c)=>e.jsx(M.div,{variants:g,className:"relative",children:e.jsx(Ue,{step:o,isActive:o.status==="active",isCompleted:o.status==="completed",onClick:l?()=>l(o.id):void 0,showConnector:c<m.length-1,connectorStatus:o.status==="completed"?"completed":o.status==="active"?"active":"pending"})},o.id))})},Ye=[{id:"extraction",name:"Extraction",status:"pending",logs:[],progress:0},{id:"validation",name:"Validation",status:"pending",logs:[],progress:0},{id:"inventory",name:"Inventory",status:"pending",logs:[],progress:0},{id:"pricing",name:"Pricing",status:"pending",logs:[],progress:0},{id:"supplier",name:"Supplier",status:"pending",logs:[],progress:0},{id:"logistics",name:"Logistics",status:"pending",logs:[],progress:0},{id:"finance",name:"Finance",status:"pending",logs:[],progress:0},{id:"confirmation",name:"Confirmation",status:"pending",logs:[],progress:0},{id:"payment",name:"Payment",status:"pending",logs:[],progress:0},{id:"blockchain",name:"Blockchain",status:"pending",logs:[],progress:0},{id:"email",name:"Email",status:"pending",logs:[],progress:0}],Rt=()=>{const[d,r]=v.useState(Ye),[s,l]=v.useState(-1),[n,m]=v.useState(!1),f=(R,A,N="info")=>{r(k=>k.map(P=>P.id===R?{...P,logs:[...P.logs,{timestamp:new Date().toISOString(),level:N,message:A,metadata:{}}]}:P))},y=(R,A,N)=>{r(k=>k.map(P=>P.id===R?{...P,status:A,progress:N??P.progress,startTime:A==="active"&&!P.startTime?new Date().toISOString():P.startTime,endTime:A==="completed"||A==="failed"?new Date().toISOString():void 0}:P))},g=async()=>{if(s>=d.length-1)return;const R=s+1,A=d[R];l(R),y(A.id,"active",0),f(A.id,`Starting ${A.name.toLowerCase()} process`);for(let N=0;N<=100&&n;N+=20)y(A.id,"active",N),N===40?f(A.id,`${A.name} process is 40% complete`):N===80&&f(A.id,`${A.name} process is 80% complete`),await new Promise(k=>setTimeout(k,500));n&&(y(A.id,"completed",100),f(A.id,`${A.name} completed successfully`),setTimeout(()=>{n&&g()},1e3))},o=()=>{m(!0),g()},c=()=>{m(!1)},b=()=>{m(!1),l(-1),r(Ye.map(R=>({...R,status:"pending",progress:0,logs:[],startTime:void 0,endTime:void 0})))},F=R=>{};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(M.div,{className:"p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Workflow Demo Controls"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(V,{onClick:o,disabled:n,className:"flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Start Demo"]}),e.jsxs(V,{onClick:c,disabled:!n,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Je,{className:"w-4 h-4"}),"Pause"]}),e.jsxs(V,{onClick:b,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"w-4 h-4"}),"Reset"]})]})]}),e.jsx(Oe,{steps:d,currentStep:s>=0?d[s]?.id:void 0,onStepClick:F,orientation:"vertical"})]})},Ne={debug:"text-slate-400 bg-slate-500/10 border-slate-500/20",info:"text-blue-400 bg-blue-500/10 border-blue-500/20",warn:"text-amber-400 bg-amber-500/10 border-amber-500/20",error:"text-red-400 bg-red-500/10 border-red-500/20"},me=d=>d.metadata?.type==="clarification_request"?{containerClass:"bg-amber-500/5 border-l-4 border-l-amber-500 hover:bg-amber-500/10",iconClass:"text-amber-500",icon:"🤔",badgeClass:"bg-amber-500/20 text-amber-700 border-amber-500/30"}:d.metadata?.type==="clarification_response"?{containerClass:"bg-emerald-500/5 border-l-4 border-l-emerald-500 hover:bg-emerald-500/10",iconClass:"text-emerald-500",icon:"✅",badgeClass:"bg-emerald-500/20 text-emerald-700 border-emerald-500/30"}:d.metadata?.type==="workflow_resume"?{containerClass:"bg-blue-500/5 border-l-4 border-l-blue-500 hover:bg-blue-500/10",iconClass:"text-blue-500",icon:"🚀",badgeClass:"bg-blue-500/20 text-blue-700 border-blue-500/30"}:null,_t={debug:"🔍",info:"ℹ️",warn:"⚠️",error:"❌"},Ft=(d,r,s=60,l=!0)=>{const[n,m]=v.useState(0),f=v.useMemo(()=>{if(!l)return{start:0,end:d.length};const o=Math.floor(n/s),c=Math.ceil(r/s),b=Math.min(o+c+5,d.length);return{start:Math.max(0,o-5),end:b}},[n,r,s,d.length,l]),y=d.length*s,g=f.start*s;return{visibleRange:f,totalHeight:y,offsetY:g,setScrollTop:m}},Xe=Te.memo(({logs:d,maxHeight:r=600,autoScroll:s=!0,filterable:l=!0,searchable:n=!0,virtualized:m=!0,className:f="",onLogClick:y,title:g="Log Stream",showControls:o=!0})=>{const[c,b]=v.useState({levels:new Set(["info","warn","error","debug"]),search:"",showClarificationOnly:!1}),[F,R]=v.useState(s),[A,N]=v.useState(!1),[k,P]=v.useState(!0),Q=v.useRef(null),I=v.useRef(null),H=v.useMemo(()=>d.filter(p=>!(c.showClarificationOnly&&!(p.metadata?.type==="clarification_request"||p.metadata?.type==="clarification_response"||p.metadata?.type==="workflow_resume")||!c.levels.has(p.level)||c.search&&!p.message.toLowerCase().includes(c.search.toLowerCase()))),[d,c]),{visibleRange:Z,totalHeight:X,offsetY:J,setScrollTop:_}=Ft(H,r,60,m),Y=m?H.slice(Z.start,Z.end):H;v.useEffect(()=>{F&&k&&I.current&&(I.current.scrollTop=I.current.scrollHeight)},[d,F,k]);const K=v.useCallback(p=>{const W=p.target,{scrollTop:U,scrollHeight:a,clientHeight:t}=W;_(U);const i=U+t>=a-10;P(i),!i&&F&&R(!1)},[F]),x=p=>new Date(p).toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3}),D=p=>{b(W=>{const U=new Set(W.levels);return U.has(p)?U.delete(p):U.add(p),{...W,levels:U}})},ne=()=>{I.current&&(I.current.scrollTop=I.current.scrollHeight,R(!0))},de=()=>{I.current&&(I.current.scrollTop=0,R(!1))},B=()=>{b({levels:new Set(["info","warn","error","debug"]),search:"",showClarificationOnly:!1})},oe=()=>{const p=H.map(t=>`[${x(t.timestamp)}] ${t.level.toUpperCase()}: ${t.message}`).join(`
`),W=new Blob([p],{type:"text/plain"}),U=URL.createObjectURL(W),a=document.createElement("a");a.href=U,a.download=`logs-${new Date().toISOString().split("T")[0]}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(U)};return e.jsxs(M.div,{ref:Q,className:re("bg-card rounded-2xl border border-border/50 overflow-hidden","shadow-xl backdrop-blur-sm",f),initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.3},children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border/50 bg-gradient-to-r from-sky-500/5 via-cyan-400/5 to-fuchsia-500/5",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:g}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[H.length," ",H.length===1?"entry":"entries"]})]}),o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>R(!F),className:re("p-2 rounded-lg border transition-colors",F?"bg-primary/10 border-primary/20 text-primary":"border-border hover:bg-muted/50"),title:F?"Disable auto-scroll":"Enable auto-scroll",children:F?e.jsx(Je,{className:"w-4 h-4"}):e.jsx(Ee,{className:"w-4 h-4"})}),e.jsx("button",{onClick:ne,className:"p-2 rounded-lg border border-border hover:bg-muted/50",title:"Scroll to bottom",children:e.jsx(We,{className:"w-4 h-4"})}),e.jsx("button",{onClick:de,className:"p-2 rounded-lg border border-border hover:bg-muted/50",title:"Scroll to top",children:e.jsx(mt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:oe,className:"p-2 rounded-lg border border-border hover:bg-muted/50",title:"Export logs",children:e.jsx(ut,{className:"w-4 h-4"})}),l&&e.jsx("button",{onClick:()=>N(!A),className:re("p-2 rounded-lg border transition-colors",A?"bg-primary/10 border-primary/20 text-primary":"border-border hover:bg-muted/50"),title:"Toggle filters",children:e.jsx(ht,{className:"w-4 h-4"})})]})]}),e.jsx(ue,{children:A&&e.jsx(M.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"border-b border-border/50 bg-muted/20",children:e.jsxs("div",{className:"p-4 space-y-4",children:[n&&e.jsxs("div",{className:"relative",children:[e.jsx(qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Search logs...",value:c.search,onChange:p=>b(W=>({...W,search:p.target.value})),className:"w-full pl-10 pr-4 py-2 bg-background border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"}),c.search&&e.jsx("button",{onClick:()=>b(p=>({...p,search:""})),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground",children:e.jsx(fe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Event Filters"}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("button",{onClick:()=>b(p=>({...p,showClarificationOnly:!p.showClarificationOnly})),className:re("flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium border transition-colors",c.showClarificationOnly?"bg-amber-500/20 text-amber-700 border-amber-500/30":"text-muted-foreground bg-muted/50 border-border hover:bg-muted"),children:[e.jsx("span",{className:"text-base",children:"🤔"}),"Clarification Events Only"]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Log Levels"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.keys(Ne).map(p=>e.jsxs("button",{onClick:()=>D(p),className:re("px-3 py-1 rounded-full text-xs font-medium border transition-colors",c.levels.has(p)?Ne[p]:"text-muted-foreground bg-muted/50 border-border hover:bg-muted"),children:[_t[p]," ",p.toUpperCase()]},p))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{onClick:B,className:"flex items-center gap-2 px-3 py-1 text-sm text-muted-foreground hover:text-foreground",children:[e.jsx(Qe,{className:"w-3 h-3"}),"Clear Filters"]})})]})})}),e.jsx("div",{ref:I,className:"overflow-y-auto",style:{maxHeight:r},onScroll:K,children:H.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-muted/20 rounded-full flex items-center justify-center mb-4",children:e.jsx(qe,{className:"w-8 h-8 text-muted-foreground/50"})}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"No Logs Found"}),e.jsx("p",{className:"text-muted-foreground max-w-sm",children:c.search||c.levels.size<4?"Try adjusting your filters to see more results.":"No log entries available yet."})]}):e.jsx("div",{style:{height:m?X:"auto",position:"relative"},children:e.jsx("div",{style:{transform:m?`translateY(${J}px)`:void 0,position:m?"absolute":void 0,top:0,left:0,right:0},children:e.jsx(ue,{mode:"popLayout",children:Y.map((p,W)=>{const U=m?Z.start+W:W;return e.jsxs(M.div,{className:re("flex items-start gap-3 p-4 border-b border-border/30 transition-colors",y&&"cursor-pointer",me(p)?.containerClass||"hover:bg-muted/30"),onClick:()=>y?.(p),initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2,delay:W*.02},layout:!0,children:[e.jsx("div",{className:"text-xs text-muted-foreground font-mono min-w-[80px] mt-1",children:x(p.timestamp)}),me(p)?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:re("text-lg",me(p)?.iconClass),children:me(p)?.icon}),e.jsx("div",{className:re("px-2 py-1 rounded-full text-xs font-medium border min-w-[80px] text-center",me(p)?.badgeClass),children:p.metadata?.type==="clarification_request"?"CLARIFY":p.metadata?.type==="clarification_response"?"RESOLVED":p.metadata?.type==="workflow_resume"?"RESUME":p.level.toUpperCase()})]}):e.jsx("div",{className:re("px-2 py-1 rounded-full text-xs font-medium border min-w-[60px] text-center",Ne[p.level]),children:p.level.toUpperCase()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm text-foreground break-words",children:p.message}),p.metadata&&e.jsxs("div",{className:"mt-2",children:[(p.metadata.type==="clarification_request"||p.metadata.type==="clarification_response")&&e.jsxs("div",{className:"space-y-2",children:[p.metadata.type==="clarification_request"&&e.jsxs("div",{className:"p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("span",{className:"text-amber-600 font-medium text-sm",children:"Clarification Details"})}),p.metadata.clarificationId&&e.jsxs("div",{className:"text-xs text-muted-foreground mb-1",children:["ID: ",p.metadata.clarificationId]}),p.metadata.timeout&&e.jsxs("div",{className:"text-xs text-amber-600 mb-1",children:["⏰ Timeout: ",p.metadata.timeout,"s"]}),p.metadata.options&&p.metadata.options.length>0&&e.jsxs("div",{className:"text-xs",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Options:"," "]}),e.jsx("span",{className:"text-foreground",children:p.metadata.options.join(", ")})]}),p.metadata.required&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:"⚠️ Response Required"})]}),p.metadata.type==="clarification_response"&&e.jsxs("div",{className:"p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("span",{className:"text-emerald-600 font-medium text-sm",children:"Response Details"})}),p.metadata.clarificationId&&e.jsxs("div",{className:"text-xs text-muted-foreground mb-1",children:["ID: ",p.metadata.clarificationId]}),p.metadata.responseTimestamp&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Responded at:"," ",new Date(p.metadata.responseTimestamp).toLocaleTimeString()]})]})]}),e.jsxs("details",{className:"mt-2",children:[e.jsxs("summary",{className:"text-xs text-muted-foreground cursor-pointer hover:text-foreground flex items-center gap-1",children:[e.jsx(Ge,{className:"w-3 h-3"}),p.metadata.type?"Additional Metadata":"Metadata"]}),e.jsx("pre",{className:"mt-2 p-2 bg-muted/50 rounded text-xs text-muted-foreground overflow-x-auto",children:JSON.stringify(p.metadata,null,2)})]})]})]})]},`${p.timestamp}-${U}`)})})})})}),e.jsx(ue,{children:!k&&e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"absolute bottom-4 right-4",children:e.jsxs("button",{onClick:ne,className:"flex items-center gap-2 px-3 py-2 bg-primary text-primary-foreground rounded-lg shadow-lg hover:bg-primary/90 transition-colors",children:[e.jsx(We,{className:"w-4 h-4"}),"New logs"]})})})]})});Xe.displayName="LogStream";const Dt=({clarificationLogs:d,onDismiss:r,className:s=""})=>{const[l,n]=v.useState([]),[m,f]=v.useState(new Set);v.useEffect(()=>{const o=new Map;d.forEach(b=>{if(b.metadata?.clarificationId){const F=b.metadata.clarificationId;if(b.metadata.type==="clarification_request"){const R=b.message.replace(/^🤔\s*Clarification Required:\s*/,"");o.set(F,{id:F,question:R,timestamp:b.timestamp,timeout:b.metadata.timeout_seconds,options:b.metadata.options,required:b.metadata.required||!1,isResolved:!1})}else if(b.metadata.type==="clarification_response"){const R=o.get(F);R&&o.set(F,{...R,isResolved:!0})}}});const c=Array.from(o.values()).filter(b=>!b.isResolved&&!m.has(b.id));n(c)},[d,m]);const y=o=>{f(c=>new Set(c).add(o)),r?.(o)},g=o=>{if(!o.timeout)return null;const c=(Date.now()-new Date(o.timestamp).getTime())/1e3,b=o.timeout-c;return Math.max(0,b)};return v.useEffect(()=>{l.forEach(o=>{const c=g(o);c!==null&&c<=30&&c>25&&xt.warning("⏰ Clarification Timeout Warning",{description:`Response needed within ${Math.ceil(c)} seconds`,duration:5e3})})},[l]),l.length===0?null:e.jsx("div",{className:`space-y-3 ${s}`,children:e.jsx(ue,{mode:"popLayout",children:l.map(o=>{const c=g(o),b=c!==null&&c<=30;return e.jsx(M.div,{initial:{opacity:0,y:-20,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-20,scale:.95},transition:{duration:.3,ease:"easeOut"},layout:!0,children:e.jsx(Lt,{className:`${b?"border-red-500/50 bg-red-500/10 animate-pulse":o.required?"border-amber-500/50 bg-amber-500/10":"border-blue-500/50 bg-blue-500/10"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:b?e.jsx(Le,{className:"h-5 w-5 text-red-500"}):e.jsx(pt,{className:"h-5 w-5 text-amber-500"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs(Et,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm",children:b?"URGENT: Clarification Required":"Clarification Required"}),o.required&&e.jsx(z,{variant:"destructive",className:"text-xs",children:"Required"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c!==null&&e.jsxs("div",{className:`flex items-center gap-1 text-xs ${b?"text-red-600":"text-amber-600"}`,children:[e.jsx(pe,{className:"h-3 w-3"}),e.jsxs("span",{children:[Math.ceil(c),"s"]})]}),e.jsx(V,{variant:"ghost",size:"sm",onClick:()=>y(o.id),className:"h-6 w-6 p-0 hover:bg-muted/50",children:e.jsx(fe,{className:"h-3 w-3"})})]})]}),e.jsx("p",{className:"text-sm mb-3 text-foreground",children:o.question}),o.options&&o.options.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Available options:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:o.options.map((F,R)=>e.jsx(z,{variant:"outline",className:"text-xs",children:F},R))})]}),e.jsxs("div",{className:"flex items-center justify-between mt-3 pt-2 border-t border-border/50",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["ID: ",o.id.slice(0,8),"..."]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(o.timestamp).toLocaleTimeString()})]})]})})]})})},o.id)})})})},$t=()=>{const{isConnected:d,startDemoOrder:r}=Mt(),{state:s}=Ie(),l=m=>{if(!d){ke.error("Not connected to WebSocket");return}if(r){r(m);const f=`DEMO-${Date.now()}`;ke.events.demoOrderSubmitted(f)}else ke.error("Demo functionality not available")},n=Object.keys(s.workflow.activeRuns).length;return e.jsxs("div",{className:"p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700","data-testid":"workflow-test-controls",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-medium",children:"Workflow Test Controls"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:d?"default":"destructive",children:d?"Connected":"Disconnected"}),n>0&&e.jsxs(z,{variant:"outline",children:[n," active run",n!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-300 mb-2",children:"Start demo workflows to test real-time updates:"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(V,{onClick:()=>l("successful_flow"),disabled:!d,size:"sm",variant:"default","data-testid":"demo-successful-flow",children:"Successful Flow"}),e.jsx(V,{onClick:()=>l("clarification_flow"),disabled:!d,size:"sm",variant:"outline",children:"Clarification Flow"}),e.jsx(V,{onClick:()=>l("error_flow"),disabled:!d,size:"sm",variant:"destructive",children:"Error Flow"})]})]}),n>0&&e.jsxs("div",{className:"pt-3 border-t border-slate-200 dark:border-slate-700",children:[e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-300 mb-2",children:"Active Workflow Runs:"}),e.jsx("div",{className:"space-y-1",children:Object.values(s.workflow.activeRuns).map(m=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-mono text-xs",children:m.id}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:m.status==="running"?"default":m.status==="completed"?"secondary":"destructive",className:"text-xs",children:m.status}),e.jsxs("span",{className:"text-slate-500",children:[m.progress.toFixed(0),"%"]})]})]},m.id))})]})]})]})},Bt=()=>{const[d,r]=v.useState([{id:"extraction",name:"Extraction",status:"pending",logs:[],progress:0},{id:"validation",name:"Validation",status:"pending",logs:[],progress:0},{id:"inventory",name:"Inventory",status:"pending",logs:[],progress:0},{id:"pricing",name:"Pricing",status:"pending",logs:[],progress:0},{id:"payment",name:"Payment",status:"pending",logs:[],progress:0}]),[s,l]=v.useState(-1),[n,m]=v.useState(!1),f=async()=>{m(!0),l(-1),r(g=>g.map(o=>({...o,status:"pending"})));for(let g=0;g<d.length;g++)l(g),r(o=>o.map((c,b)=>({...c,status:b===g?"active":b<g?"completed":"pending"}))),await new Promise(o=>setTimeout(o,2e3)),r(o=>o.map((c,b)=>({...c,status:b<=g?"completed":"pending"}))),await new Promise(o=>setTimeout(o,500));l(-1),m(!1)},y=()=>{r(g=>g.map(o=>({...o,status:"pending"}))),l(-1),m(!1)};return e.jsxs("div",{className:"p-6 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Step Highlighting Test"}),e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx(V,{onClick:f,disabled:n,variant:"default",children:n?"Running Test...":"Run Step Test"}),e.jsx(V,{onClick:y,disabled:n,variant:"outline",children:"Reset"})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("p",{className:"text-sm text-slate-600 dark:text-slate-300",children:["Current Status:"," ",n?`Step ${s+1} of ${d.length}`:"Idle"]})}),e.jsx(Oe,{steps:d,currentStep:s>=0?d[s]?.id:void 0,orientation:"vertical"}),e.jsxs("div",{className:"mt-4 p-3 bg-white dark:bg-slate-900 rounded border",children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Step States:"}),e.jsx("div",{className:"text-xs space-y-1",children:d.map((g,o)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx("span",{className:"w-16 font-mono",children:g.id}),e.jsx("span",{className:`w-16 font-bold ${g.status==="active"?"text-blue-600":g.status==="completed"?"text-green-600":"text-gray-500"}`,children:g.status}),e.jsx("span",{children:g.name})]},g.id))})]})]})},zt=()=>{const{state:d,updateWorkflowRun:r}=Ie(),s=Object.values(d.workflow.activeRuns)[0],l=()=>{if(!s)return;const g=s.steps.map(c=>c.status==="active"||c.status==="pending"?{...c,status:"completed",endTime:new Date().toISOString(),progress:100}:c),o=g.filter(c=>c.status==="completed").length;r(s.id,{steps:g,status:"completed",progress:100,completedSteps:o,endTime:new Date().toISOString()})},n=()=>{if(!s)return;const g=s.steps.map(o=>({...o,status:"pending",startTime:void 0,endTime:void 0,progress:0}));r(s.id,{steps:g,status:"pending",progress:0,completedSteps:0,endTime:void 0})},m=()=>{s&&s.steps.forEach((g,o)=>{})};if(!s)return e.jsx("div",{className:"p-4 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg",children:e.jsx("p",{className:"text-amber-800 dark:text-amber-200",children:"No active workflow to debug"})});const f=s.steps.filter(g=>g.status==="active"||g.status==="pending"),y=f.length>0;return e.jsxs("div",{className:"p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Workflow Debug Controls"}),y&&e.jsxs("div",{className:"mb-4 p-3 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg",children:[e.jsxs("h4",{className:"text-sm font-medium text-amber-800 dark:text-amber-200 mb-2",children:["⚠️ Detected ",f.length," stuck steps"]}),e.jsx("div",{className:"text-xs text-amber-700 dark:text-amber-300 space-y-1",children:f.map(g=>e.jsxs("div",{children:["• ",g.id," (",g.name,"): ",g.status]},g.id))})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(V,{onClick:l,variant:"default",size:"sm",disabled:!y,children:"Fix Stuck Steps"}),e.jsx(V,{onClick:n,variant:"outline",size:"sm",children:"Reset Workflow"}),e.jsx(V,{onClick:m,variant:"outline",size:"sm",children:"Log State"})]}),e.jsxs("div",{className:"mt-4 text-xs text-slate-600 dark:text-slate-300",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Fix Stuck Steps:"})," Marks all active/pending steps as completed"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reset Workflow:"})," Resets all steps to pending state"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Log State:"})," Prints current workflow state to console"]})]})]})};var Re={};(function d(r,s,l,n){var m=!!(r.Worker&&r.Blob&&r.Promise&&r.OffscreenCanvas&&r.OffscreenCanvasRenderingContext2D&&r.HTMLCanvasElement&&r.HTMLCanvasElement.prototype.transferControlToOffscreen&&r.URL&&r.URL.createObjectURL),f=typeof Path2D=="function"&&typeof DOMMatrix=="function",y=(function(){if(!r.OffscreenCanvas)return!1;var a=new OffscreenCanvas(1,1),t=a.getContext("2d");t.fillRect(0,0,1,1);var i=a.transferToImageBitmap();try{t.createPattern(i,"no-repeat")}catch{return!1}return!0})();function g(){}function o(a){var t=s.exports.Promise,i=t!==void 0?t:r.Promise;return typeof i=="function"?new i(a):(a(g,g),null)}var c=(function(a,t){return{transform:function(i){if(a)return i;if(t.has(i))return t.get(i);var h=new OffscreenCanvas(i.width,i.height),w=h.getContext("2d");return w.drawImage(i,0,0),t.set(i,h),h},clear:function(){t.clear()}}})(y,new Map),b=(function(){var a=Math.floor(16.666666666666668),t,i,h={},w=0;return typeof requestAnimationFrame=="function"&&typeof cancelAnimationFrame=="function"?(t=function(C){var S=Math.random();return h[S]=requestAnimationFrame(function j(T){w===T||w+a-1<T?(w=T,delete h[S],C()):h[S]=requestAnimationFrame(j)}),S},i=function(C){h[C]&&cancelAnimationFrame(h[C])}):(t=function(C){return setTimeout(C,a)},i=function(C){return clearTimeout(C)}),{frame:t,cancel:i}})(),F=(function(){var a,t,i={};function h(w){function C(S,j){w.postMessage({options:S||{},callback:j})}w.init=function(j){var T=j.transferControlToOffscreen();w.postMessage({canvas:T},[T])},w.fire=function(j,T,u){if(t)return C(j,null),t;var L=Math.random().toString(36).slice(2);return t=o(function(E){function $(q){q.data.callback===L&&(delete i[L],w.removeEventListener("message",$),t=null,c.clear(),u(),E())}w.addEventListener("message",$),C(j,L),i[L]=$.bind(null,{data:{callback:L}})}),t},w.reset=function(){w.postMessage({reset:!0});for(var j in i)i[j](),delete i[j]}}return function(){if(a)return a;if(!l&&m){var w=["var CONFETTI, SIZE = {}, module = {};","("+d.toString()+")(this, module, true, SIZE);","onmessage = function(msg) {","  if (msg.data.options) {","    CONFETTI(msg.data.options).then(function () {","      if (msg.data.callback) {","        postMessage({ callback: msg.data.callback });","      }","    });","  } else if (msg.data.reset) {","    CONFETTI && CONFETTI.reset();","  } else if (msg.data.resize) {","    SIZE.width = msg.data.resize.width;","    SIZE.height = msg.data.resize.height;","  } else if (msg.data.canvas) {","    SIZE.width = msg.data.canvas.width;","    SIZE.height = msg.data.canvas.height;","    CONFETTI = module.exports.create(msg.data.canvas);","  }","}"].join(`
`);try{a=new Worker(URL.createObjectURL(new Blob([w])))}catch{return null}h(a)}return a}})(),R={particleCount:50,angle:90,spread:45,startVelocity:45,decay:.9,gravity:1,drift:0,ticks:200,x:.5,y:.5,shapes:["square","circle"],zIndex:100,colors:["#26ccff","#a25afd","#ff5e7e","#88ff5a","#fcff42","#ffa62d","#ff36ff"],disableForReducedMotion:!1,scalar:1};function A(a,t){return t?t(a):a}function N(a){return a!=null}function k(a,t,i){return A(a&&N(a[t])?a[t]:R[t],i)}function P(a){return a<0?0:Math.floor(a)}function Q(a,t){return Math.floor(Math.random()*(t-a))+a}function I(a){return parseInt(a,16)}function H(a){return a.map(Z)}function Z(a){var t=String(a).replace(/[^0-9a-f]/gi,"");return t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),{r:I(t.substring(0,2)),g:I(t.substring(2,4)),b:I(t.substring(4,6))}}function X(a){var t=k(a,"origin",Object);return t.x=k(t,"x",Number),t.y=k(t,"y",Number),t}function J(a){a.width=document.documentElement.clientWidth,a.height=document.documentElement.clientHeight}function _(a){var t=a.getBoundingClientRect();a.width=t.width,a.height=t.height}function Y(a){var t=document.createElement("canvas");return t.style.position="fixed",t.style.top="0px",t.style.left="0px",t.style.pointerEvents="none",t.style.zIndex=a,t}function K(a,t,i,h,w,C,S,j,T){a.save(),a.translate(t,i),a.rotate(C),a.scale(h,w),a.arc(0,0,1,S,j,T),a.restore()}function x(a){var t=a.angle*(Math.PI/180),i=a.spread*(Math.PI/180);return{x:a.x,y:a.y,wobble:Math.random()*10,wobbleSpeed:Math.min(.11,Math.random()*.1+.05),velocity:a.startVelocity*.5+Math.random()*a.startVelocity,angle2D:-t+(.5*i-Math.random()*i),tiltAngle:(Math.random()*(.75-.25)+.25)*Math.PI,color:a.color,shape:a.shape,tick:0,totalTicks:a.ticks,decay:a.decay,drift:a.drift,random:Math.random()+2,tiltSin:0,tiltCos:0,wobbleX:0,wobbleY:0,gravity:a.gravity*3,ovalScalar:.6,scalar:a.scalar,flat:a.flat}}function D(a,t){t.x+=Math.cos(t.angle2D)*t.velocity+t.drift,t.y+=Math.sin(t.angle2D)*t.velocity+t.gravity,t.velocity*=t.decay,t.flat?(t.wobble=0,t.wobbleX=t.x+10*t.scalar,t.wobbleY=t.y+10*t.scalar,t.tiltSin=0,t.tiltCos=0,t.random=1):(t.wobble+=t.wobbleSpeed,t.wobbleX=t.x+10*t.scalar*Math.cos(t.wobble),t.wobbleY=t.y+10*t.scalar*Math.sin(t.wobble),t.tiltAngle+=.1,t.tiltSin=Math.sin(t.tiltAngle),t.tiltCos=Math.cos(t.tiltAngle),t.random=Math.random()+2);var i=t.tick++/t.totalTicks,h=t.x+t.random*t.tiltCos,w=t.y+t.random*t.tiltSin,C=t.wobbleX+t.random*t.tiltCos,S=t.wobbleY+t.random*t.tiltSin;if(a.fillStyle="rgba("+t.color.r+", "+t.color.g+", "+t.color.b+", "+(1-i)+")",a.beginPath(),f&&t.shape.type==="path"&&typeof t.shape.path=="string"&&Array.isArray(t.shape.matrix))a.fill(p(t.shape.path,t.shape.matrix,t.x,t.y,Math.abs(C-h)*.1,Math.abs(S-w)*.1,Math.PI/10*t.wobble));else if(t.shape.type==="bitmap"){var j=Math.PI/10*t.wobble,T=Math.abs(C-h)*.1,u=Math.abs(S-w)*.1,L=t.shape.bitmap.width*t.scalar,E=t.shape.bitmap.height*t.scalar,$=new DOMMatrix([Math.cos(j)*T,Math.sin(j)*T,-Math.sin(j)*u,Math.cos(j)*u,t.x,t.y]);$.multiplySelf(new DOMMatrix(t.shape.matrix));var q=a.createPattern(c.transform(t.shape.bitmap),"no-repeat");q.setTransform($),a.globalAlpha=1-i,a.fillStyle=q,a.fillRect(t.x-L/2,t.y-E/2,L,E),a.globalAlpha=1}else if(t.shape==="circle")a.ellipse?a.ellipse(t.x,t.y,Math.abs(C-h)*t.ovalScalar,Math.abs(S-w)*t.ovalScalar,Math.PI/10*t.wobble,0,2*Math.PI):K(a,t.x,t.y,Math.abs(C-h)*t.ovalScalar,Math.abs(S-w)*t.ovalScalar,Math.PI/10*t.wobble,0,2*Math.PI);else if(t.shape==="star")for(var O=Math.PI/2*3,G=4*t.scalar,ee=8*t.scalar,te=t.x,se=t.y,le=5,ae=Math.PI/le;le--;)te=t.x+Math.cos(O)*ee,se=t.y+Math.sin(O)*ee,a.lineTo(te,se),O+=ae,te=t.x+Math.cos(O)*G,se=t.y+Math.sin(O)*G,a.lineTo(te,se),O+=ae;else a.moveTo(Math.floor(t.x),Math.floor(t.y)),a.lineTo(Math.floor(t.wobbleX),Math.floor(w)),a.lineTo(Math.floor(C),Math.floor(S)),a.lineTo(Math.floor(h),Math.floor(t.wobbleY));return a.closePath(),a.fill(),t.tick<t.totalTicks}function ne(a,t,i,h,w){var C=t.slice(),S=a.getContext("2d"),j,T,u=o(function(L){function E(){j=T=null,S.clearRect(0,0,h.width,h.height),c.clear(),w(),L()}function $(){l&&!(h.width===n.width&&h.height===n.height)&&(h.width=a.width=n.width,h.height=a.height=n.height),!h.width&&!h.height&&(i(a),h.width=a.width,h.height=a.height),S.clearRect(0,0,h.width,h.height),C=C.filter(function(q){return D(S,q)}),C.length?j=b.frame($):E()}j=b.frame($),T=E});return{addFettis:function(L){return C=C.concat(L),u},canvas:a,promise:u,reset:function(){j&&b.cancel(j),T&&T()}}}function de(a,t){var i=!a,h=!!k(t||{},"resize"),w=!1,C=k(t,"disableForReducedMotion",Boolean),S=m&&!!k(t||{},"useWorker"),j=S?F():null,T=i?J:_,u=a&&j?!!a.__confetti_initialized:!1,L=typeof matchMedia=="function"&&matchMedia("(prefers-reduced-motion)").matches,E;function $(O,G,ee){for(var te=k(O,"particleCount",P),se=k(O,"angle",Number),le=k(O,"spread",Number),ae=k(O,"startVelocity",Number),et=k(O,"decay",Number),tt=k(O,"gravity",Number),at=k(O,"drift",Number),_e=k(O,"colors",H),st=k(O,"ticks",Number),Fe=k(O,"shapes"),rt=k(O,"scalar"),nt=!!k(O,"flat"),De=X(O),$e=te,ge=[],it=a.width*De.x,ot=a.height*De.y;$e--;)ge.push(x({x:it,y:ot,angle:se,spread:le,startVelocity:ae,color:_e[$e%_e.length],shape:Fe[Q(0,Fe.length)],ticks:st,decay:et,gravity:tt,drift:at,scalar:rt,flat:nt}));return E?E.addFettis(ge):(E=ne(a,ge,T,G,ee),E.promise)}function q(O){var G=C||k(O,"disableForReducedMotion",Boolean),ee=k(O,"zIndex",Number);if(G&&L)return o(function(ae){ae()});i&&E?a=E.canvas:i&&!a&&(a=Y(ee),document.body.appendChild(a)),h&&!u&&T(a);var te={width:a.width,height:a.height};j&&!u&&j.init(a),u=!0,j&&(a.__confetti_initialized=!0);function se(){if(j){var ae={getBoundingClientRect:function(){if(!i)return a.getBoundingClientRect()}};T(ae),j.postMessage({resize:{width:ae.width,height:ae.height}});return}te.width=te.height=null}function le(){E=null,h&&(w=!1,r.removeEventListener("resize",se)),i&&a&&(document.body.contains(a)&&document.body.removeChild(a),a=null,u=!1)}return h&&!w&&(w=!0,r.addEventListener("resize",se,!1)),j?j.fire(O,te,le):$(O,te,le)}return q.reset=function(){j&&j.reset(),E&&E.reset()},q}var B;function oe(){return B||(B=de(null,{useWorker:!0,resize:!0})),B}function p(a,t,i,h,w,C,S){var j=new Path2D(a),T=new Path2D;T.addPath(j,new DOMMatrix(t));var u=new Path2D;return u.addPath(T,new DOMMatrix([Math.cos(S)*w,Math.sin(S)*w,-Math.sin(S)*C,Math.cos(S)*C,i,h])),u}function W(a){if(!f)throw new Error("path confetti are not supported in this browser");var t,i;typeof a=="string"?t=a:(t=a.path,i=a.matrix);var h=new Path2D(t),w=document.createElement("canvas"),C=w.getContext("2d");if(!i){for(var S=1e3,j=S,T=S,u=0,L=0,E,$,q=0;q<S;q+=2)for(var O=0;O<S;O+=2)C.isPointInPath(h,q,O,"nonzero")&&(j=Math.min(j,q),T=Math.min(T,O),u=Math.max(u,q),L=Math.max(L,O));E=u-j,$=L-T;var G=10,ee=Math.min(G/E,G/$);i=[ee,0,0,ee,-Math.round(E/2+j)*ee,-Math.round($/2+T)*ee]}return{type:"path",path:t,matrix:i}}function U(a){var t,i=1,h="#000000",w='"Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", "EmojiOne Color", "Android Emoji", "Twemoji Mozilla", "system emoji", sans-serif';typeof a=="string"?t=a:(t=a.text,i="scalar"in a?a.scalar:i,w="fontFamily"in a?a.fontFamily:w,h="color"in a?a.color:h);var C=10*i,S=""+C+"px "+w,j=new OffscreenCanvas(C,C),T=j.getContext("2d");T.font=S;var u=T.measureText(t),L=Math.ceil(u.actualBoundingBoxRight+u.actualBoundingBoxLeft),E=Math.ceil(u.actualBoundingBoxAscent+u.actualBoundingBoxDescent),$=2,q=u.actualBoundingBoxLeft+$,O=u.actualBoundingBoxAscent+$;L+=$+$,E+=$+$,j=new OffscreenCanvas(L,E),T=j.getContext("2d"),T.font=S,T.fillStyle=h,T.fillText(t,q,O);var G=1/i;return{type:"bitmap",bitmap:j.transferToImageBitmap(),matrix:[G,0,0,G,-L*G/2,-E*G/2]}}s.exports=function(){return oe().apply(this,arguments)},s.exports.reset=function(){oe().reset()},s.exports.create=de,s.exports.shapeFromPath=W,s.exports.shapeFromText=U})((function(){return typeof window<"u"?window:typeof self<"u"?self:this||{}})(),Re,!1);const Ke=Re.exports;Re.exports.create;const Wt=()=>{const r=Date.now()+3e3,s=["#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6"];(function l(){Ke({particleCount:3,angle:60,spread:55,origin:{x:.1,y:.8},colors:s}),Ke({particleCount:3,angle:120,spread:55,origin:{x:.9,y:.8},colors:s}),Date.now()<r&&requestAnimationFrame(l)})()},qt=({isVisible:d,onClose:r,orderData:s})=>{const[l,n]=v.useState(!1),[m,f]=v.useState(!1);v.useEffect(()=>{},[d]);const y=()=>{m||(f(!0),n(!1),setTimeout(()=>{r(),f(!1)},100))};v.useEffect(()=>{if(d&&!l){n(!0),Wt();const c=setTimeout(()=>n(!1),5e3);return()=>clearTimeout(c)}},[d,l]);const g=()=>{if(s.paymentLink&&s.paymentLink.includes("checkout.stripe.com"))window.open(s.paymentLink,"_blank","noopener,noreferrer");else{const c=s.paymentLink?`Payment link appears invalid: ${s.paymentLink}`:"Payment link is not available. The payment step may not have completed successfully.";alert(c+`

Please check the workflow logs or contact support.`)}},o=()=>{if(s.blockchainTxHash&&s.blockchainTxHash!=="0x1234567890abcdef"&&s.blockchainTxHash.length>=40){let c=s.blockchainTxHash;if(c.includes("/tx/")&&(c=c.split("/tx/")[1]),c=c.replace(/^0x/,""),!/^[a-fA-F0-9]{64}$/.test(c)){alert("Invalid blockchain transaction hash format");return}const b=`https://amoy.polygonscan.com/tx/0x${c}`;window.open(b,"_blank","noopener,noreferrer")}else alert("Blockchain transaction hash not available or invalid")};return d?e.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm cursor-pointer",onClick:y}),e.jsx(M.div,{className:"relative z-10 w-full max-w-2xl",initial:{scale:.8,y:50,opacity:0},animate:{scale:1,y:0,opacity:1},exit:{scale:.8,y:50,opacity:0},transition:{type:"spring",stiffness:300,damping:30},children:e.jsxs(Me,{className:"w-full max-w-4xl max-h-[90vh] overflow-y-auto bg-gradient-to-br from-white via-green-50 to-emerald-50 dark:from-slate-900 dark:via-green-950 dark:to-emerald-950 border-2 border-green-200 dark:border-green-800 shadow-2xl relative",children:[e.jsx("button",{className:"absolute top-4 right-4 z-20 p-2 rounded-full bg-white/80 hover:bg-red-100 dark:bg-slate-800/80 dark:hover:bg-red-900 transition-colors cursor-pointer",onClick:y,type:"button","aria-label":"Close completion card",children:e.jsx(fe,{className:"w-4 h-4 text-gray-600 dark:text-gray-300"})}),e.jsxs(Ae,{className:"text-center pb-4 pt-4",children:[e.jsx(M.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring",stiffness:300},className:"flex items-center justify-center mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"w-16 h-16 text-green-500"}),e.jsx(M.div,{className:"absolute -top-1 -right-1",animate:{rotate:[0,15,-15,0]},transition:{duration:2,repeat:1/0},children:e.jsx(ft,{className:"w-6 h-6 text-yellow-500"})})]})}),e.jsx(M.h2,{className:"text-3xl font-bold text-green-700 dark:text-green-300 mb-2",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},children:"Order Completed Successfully! 🎉"}),e.jsx(M.p,{className:"text-slate-600 dark:text-slate-300",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},children:"Your order has been processed and is ready for payment"})]}),e.jsxs(Pe,{className:"space-y-6 pb-4",children:[e.jsxs(M.div,{className:"bg-white/70 dark:bg-slate-800/70 rounded-2xl p-6 border border-green-200 dark:border-green-800",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.5},children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5 text-green-500"}),"Order Summary"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(gt,{className:"w-4 h-4 text-slate-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:"Order ID:"}),e.jsx("p",{className:"font-mono font-medium",children:s.orderId})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-4 h-4 text-slate-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:"Model:"}),e.jsx("p",{className:"font-medium",children:s.model})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-4 h-4 text-slate-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:"Quantity:"}),e.jsx("p",{className:"font-medium",children:s.quantity})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bt,{className:"w-4 h-4 text-green-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:"Total Amount:"}),e.jsx("p",{className:"font-bold text-green-600 dark:text-green-400",children:s.totalAmount})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4 text-slate-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:"Buyer:"}),e.jsx("p",{className:"font-medium",children:s.buyerEmail})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"w-4 h-4 text-slate-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:"Delivery:"}),e.jsx("p",{className:"font-medium",children:s.deliveryLocation})]})]})]})]}),e.jsxs(M.div,{className:"bg-white/70 dark:bg-slate-800/70 rounded-2xl p-6 border border-blue-200 dark:border-blue-800",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{delay:.6},children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(xe,{className:"w-5 h-5 text-blue-500"}),"Transaction Details"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-200 dark:border-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ye,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm font-medium text-blue-700 dark:text-blue-300",children:"Payment Link"})]}),s.paymentLink?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-xs font-mono text-blue-600 dark:text-blue-400 truncate flex-1",children:[s.paymentLink.substring(0,50),"..."]}),e.jsx(z,{variant:"secondary",className:"text-xs",children:"Ready"})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4 text-amber-500"}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400",children:"Payment link not available"})]})]}),s.blockchainTxHash?e.jsxs("div",{className:"p-4 bg-purple-50 dark:bg-purple-950/30 rounded-lg border border-purple-200 dark:border-purple-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(xe,{className:"w-4 h-4 text-purple-500"}),e.jsx("span",{className:"text-sm font-medium text-purple-700 dark:text-purple-300",children:"Blockchain Transaction"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-xs font-mono text-purple-600 dark:text-purple-400 truncate flex-1",children:s.blockchainTxHash}),e.jsx(z,{variant:"secondary",className:"text-xs",children:"Recorded"})]}),e.jsx("p",{className:"text-xs text-purple-500 dark:text-purple-400 mt-1",children:"View on Polygon Amoy Testnet"})]}):e.jsx("div",{className:"p-4 bg-gray-50 dark:bg-gray-950/30 rounded-lg border border-gray-200 dark:border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Blockchain transaction not available"})]})}),s.emailConfirmationId&&e.jsxs("div",{className:"p-4 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-200 dark:border-green-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(be,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{className:"text-sm font-medium text-green-700 dark:text-green-300",children:"Email Confirmation"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-xs font-mono text-green-600 dark:text-green-400",children:["ID: ",s.emailConfirmationId]}),e.jsx(z,{variant:"secondary",className:"text-xs",children:"Sent"})]})]})]})]}),e.jsxs(M.div,{className:"flex flex-col sm:flex-row gap-4",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},children:[e.jsxs("button",{onClick:g,disabled:!s.paymentLink||!s.paymentLink.includes("checkout.stripe.com"),className:`flex-1 font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-3 ${s.paymentLink&&s.paymentLink.includes("checkout.stripe.com")?"bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white transform hover:scale-105":"bg-gradient-to-r from-gray-400 to-gray-500 text-white cursor-not-allowed opacity-75"}`,type:"button",children:[e.jsx(ye,{className:"w-5 h-5"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{children:s.paymentLink&&s.paymentLink.includes("checkout.stripe.com")?"Complete Payment":"Payment Link Unavailable"}),s.paymentLink&&s.paymentLink.includes("checkout.stripe.com")&&e.jsx("span",{className:"text-xs opacity-90",children:"Secure Stripe Checkout"})]}),e.jsx(he,{className:"w-4 h-4"})]}),e.jsxs("button",{onClick:o,disabled:!s.blockchainTxHash,className:`flex-1 font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 ${s.blockchainTxHash?"border-2 border-purple-200 hover:border-purple-300 hover:bg-purple-50 dark:border-purple-800 dark:hover:border-purple-700 dark:hover:bg-purple-950 transform hover:scale-105":"border-2 border-gray-200 dark:border-gray-700 text-gray-400 dark:text-gray-600 cursor-not-allowed opacity-75"}`,type:"button",children:[e.jsx(xe,{className:"w-5 h-5"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{children:s.blockchainTxHash?"View on Blockchain":"Blockchain Pending"}),s.blockchainTxHash&&e.jsx("span",{className:"text-xs opacity-75",children:"Polygon Amoy Testnet"})]}),e.jsx(he,{className:"w-4 h-4"})]})]}),e.jsxs(M.div,{className:"flex flex-wrap gap-2 justify-center",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},children:[e.jsxs(z,{variant:"secondary",className:"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 flex items-center gap-1",children:[e.jsx(ce,{className:"w-3 h-3"}),"Order Processed"]}),e.jsxs(z,{variant:"secondary",className:`flex items-center gap-1 ${s.paymentLink?"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300":"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300"}`,children:[e.jsx(ye,{className:"w-3 h-3"}),s.paymentLink?"Payment Ready":"Payment Pending"]}),e.jsxs(z,{variant:"secondary",className:`flex items-center gap-1 ${s.blockchainTxHash?"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300":"bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300"}`,children:[e.jsx(xe,{className:"w-3 h-3"}),s.blockchainTxHash?"Blockchain Recorded":"Blockchain Pending"]}),e.jsxs(z,{variant:"secondary",className:"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300 flex items-center gap-1",children:[e.jsx(be,{className:"w-3 h-3"}),"Email Sent"]})]}),!1,e.jsx(M.div,{className:"text-center text-sm text-slate-500 dark:text-slate-400 pt-4 border-t border-green-200 dark:border-green-800",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:["Thank you for your order! A confirmation email has been sent to"," ",e.jsx("span",{className:"font-medium text-slate-700 dark:text-slate-300",children:s.buyerEmail})]}),e.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs",children:[s.paymentLink&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"w-3 h-3 text-green-500"}),"Payment link ready"]}),s.blockchainTxHash&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"w-3 h-3 text-purple-500"}),"Blockchain verified"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"w-3 h-3 text-orange-500"}),"Email delivered"]})]})]})})]})]})})]}):null};class Ht extends v.Component{maxRetries=3;constructor(r){super(r),this.state={hasError:!1,error:null,errorInfo:null,retryCount:0}}static getDerivedStateFromError(r){return{hasError:!0,error:r}}componentDidCatch(r,s){this.setState({error:r,errorInfo:s}),typeof window<"u"&&window.reportError&&window.reportError(r,{context:"OrderCompletionCard",componentStack:s.componentStack,retryCount:this.state.retryCount})}handleRetry=()=>{this.state.retryCount<this.maxRetries&&this.setState({hasError:!1,error:null,errorInfo:null,retryCount:this.state.retryCount+1})};handleClose=()=>{this.props.onClose()};handlePaymentFallback=()=>{const{fallbackData:r}=this.props;r?.paymentLink&&r.paymentLink.includes("checkout.stripe.com")?window.open(r.paymentLink,"_blank","noopener,noreferrer"):alert("Payment link is not available. Please check the workflow logs or contact support.")};handleBlockchainFallback=()=>{const{fallbackData:r}=this.props;if(r?.blockchainTxHash&&r.blockchainTxHash.length>=40){let s=r.blockchainTxHash;if(s.includes("/tx/")&&(s=s.split("/tx/")[1]),s=s.replace(/^0x/,""),/^[a-fA-F0-9]{64}$/.test(s)){const l=`https://amoy.polygonscan.com/tx/0x${s}`;window.open(l,"_blank","noopener,noreferrer")}else alert("Blockchain transaction hash format is invalid.")}else alert("Blockchain transaction hash is not available.")};render(){if(this.state.hasError){const{fallbackData:r}=this.props,s=this.state.retryCount<this.maxRetries;return e.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm cursor-pointer",onClick:this.handleClose}),e.jsx(M.div,{className:"relative z-10 w-full max-w-2xl",initial:{scale:.8,y:50,opacity:0},animate:{scale:1,y:0,opacity:1},transition:{type:"spring",stiffness:300,damping:30},children:e.jsxs(Me,{className:"w-full max-w-4xl max-h-[90vh] overflow-y-auto bg-gradient-to-br from-white via-red-50 to-orange-50 dark:from-slate-900 dark:via-red-950 dark:to-orange-950 border-2 border-red-200 dark:border-red-800 shadow-2xl relative",children:[e.jsx("button",{className:"absolute top-4 right-4 z-20 p-2 rounded-full bg-white/80 hover:bg-red-100 dark:bg-slate-800/80 dark:hover:bg-red-900 transition-colors cursor-pointer",onClick:this.handleClose,type:"button","aria-label":"Close error dialog",children:e.jsx(fe,{className:"w-4 h-4 text-gray-600 dark:text-gray-300"})}),e.jsxs(Ae,{className:"text-center pb-4 pt-4",children:[e.jsx(M.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring",stiffness:300},className:"flex items-center justify-center mb-4",children:e.jsx(Se,{className:"w-16 h-16 text-red-500"})}),e.jsx(M.h2,{className:"text-3xl font-bold text-red-700 dark:text-red-300 mb-2",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},children:"Order Completion Card Error"}),e.jsx(M.p,{className:"text-slate-600 dark:text-slate-300",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},children:"There was an error displaying your order completion details, but your order was processed successfully."})]}),e.jsxs(Pe,{className:"space-y-6 pb-4",children:[e.jsxs(M.div,{className:"bg-white/70 dark:bg-slate-800/70 rounded-2xl p-6 border border-red-200 dark:border-red-800",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.5},children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Se,{className:"w-5 h-5 text-red-500"}),"Error Information"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-red-50 dark:bg-red-950/30 rounded-lg border border-red-200 dark:border-red-800",children:[e.jsx("p",{className:"text-sm font-medium text-red-700 dark:text-red-300 mb-1",children:"Error Message:"}),e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 font-mono",children:this.state.error?.message||"Unknown error occurred"})]}),e.jsxs("div",{className:"p-3 bg-orange-50 dark:bg-orange-950/30 rounded-lg border border-orange-200 dark:border-orange-800",children:[e.jsx("p",{className:"text-sm font-medium text-orange-700 dark:text-orange-300 mb-1",children:"What this means:"}),e.jsx("p",{className:"text-sm text-orange-600 dark:text-orange-400",children:"Your order was processed successfully, but there was a display issue with the completion card. You can still access your payment link and blockchain transaction using the buttons below."})]})]})]}),r&&e.jsxs(M.div,{className:"bg-white/70 dark:bg-slate-800/70 rounded-2xl p-6 border border-blue-200 dark:border-blue-800",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{delay:.6},children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(he,{className:"w-5 h-5 text-blue-500"}),"Available Order Information"]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[r.orderId&&e.jsxs("div",{className:"flex items-center justify-between p-2 bg-blue-50 dark:bg-blue-950/30 rounded",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Order ID:"}),e.jsx("span",{className:"font-mono font-medium",children:r.orderId})]}),r.buyerEmail&&e.jsxs("div",{className:"flex items-center justify-between p-2 bg-blue-50 dark:bg-blue-950/30 rounded",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Buyer Email:"}),e.jsx("span",{className:"font-medium",children:r.buyerEmail})]}),r.paymentLink&&e.jsxs("div",{className:"p-2 bg-green-50 dark:bg-green-950/30 rounded border border-green-200 dark:border-green-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-green-700 dark:text-green-300",children:"Payment Link Available"}),e.jsx(z,{variant:"secondary",className:"text-xs",children:"Ready"})]}),e.jsx("p",{className:"text-xs text-green-600 dark:text-green-400",children:"Click the payment button below to complete your purchase"})]}),r.blockchainTxHash&&e.jsxs("div",{className:"p-2 bg-purple-50 dark:bg-purple-950/30 rounded border border-purple-200 dark:border-purple-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-purple-700 dark:text-purple-300",children:"Blockchain Transaction"}),e.jsx(z,{variant:"secondary",className:"text-xs",children:"Recorded"})]}),e.jsxs("p",{className:"text-xs text-purple-600 dark:text-purple-400",children:["Transaction:"," ",r.blockchainTxHash.substring(0,20),"..."]})]})]})]}),e.jsxs(M.div,{className:"space-y-4",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},children:[s&&e.jsxs("button",{onClick:this.handleRetry,className:"w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-3 transform hover:scale-105",type:"button",children:[e.jsx(vt,{className:"w-5 h-5"}),"Retry Loading Completion Card",e.jsxs("span",{className:"text-xs opacity-90",children:["(",this.state.retryCount+1,"/",this.maxRetries,")"]})]}),r&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[r.paymentLink&&e.jsxs("button",{onClick:this.handlePaymentFallback,className:"flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-3 transform hover:scale-105",type:"button",children:[e.jsx(he,{className:"w-5 h-5"}),"Complete Payment"]}),r.blockchainTxHash&&e.jsxs("button",{onClick:this.handleBlockchainFallback,className:"flex-1 border-2 border-purple-200 hover:border-purple-300 hover:bg-purple-50 dark:border-purple-800 dark:hover:border-purple-700 dark:hover:bg-purple-950 font-semibold py-3 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 transform hover:scale-105",type:"button",children:[e.jsx(he,{className:"w-5 h-5"}),"View on Blockchain"]})]})]}),e.jsxs(M.div,{className:"bg-yellow-50 dark:bg-yellow-950/30 rounded-lg p-4 border border-yellow-200 dark:border-yellow-800",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.8},children:[e.jsx("h4",{className:"text-sm font-semibold text-yellow-700 dark:text-yellow-300 mb-2",children:"Important Information:"}),e.jsxs("ul",{className:"text-xs text-yellow-600 dark:text-yellow-400 space-y-1",children:[e.jsx("li",{children:"• Your order has been processed successfully"}),e.jsx("li",{children:"• A confirmation email has been sent to your email address"}),e.jsx("li",{children:"• You can still complete payment using the payment link"}),e.jsx("li",{children:"• The blockchain transaction has been recorded (if applicable)"}),e.jsx("li",{children:"• Contact support if you need assistance: support@portia.ai"})]})]}),!1]})]})})]})}return this.props.children}}class Zt{completionStates=new Map;completionTimers=new Map;getCompletionState(r){return this.completionStates.get(r)||{isCompleted:!1,completionTrigger:null,completionTimestamp:null,completionData:null,prematureTriggersBlocked:[],hasShownCard:!1,cardDismissed:!1}}markEmailCompletion(r,s,l){const n=this.completionTimers.get(r);n&&clearTimeout(n);const m=this.getCompletionState(r);this.completionStates.set(r,{...m,isCompleted:!0,completionTrigger:"email",completionTimestamp:new Date().toISOString(),completionData:s});const f=setTimeout(()=>{const y=this.getCompletionState(r);y.isCompleted&&!y.hasShownCard&&!y.cardDismissed&&l(),this.completionTimers.delete(r)},1e3);this.completionTimers.set(r,f)}blockPrematureCompletion(r,s){const l=this.getCompletionState(r),n=[...l.prematureTriggersBlocked,s];this.completionStates.set(r,{...l,prematureTriggersBlocked:n})}markCompletionCardShown(r){const s=this.getCompletionState(r);this.completionStates.set(r,{...s,hasShownCard:!0})}markCompletionCardDismissed(r){const s=this.getCompletionState(r);this.completionStates.set(r,{...s,cardDismissed:!0})}shouldPreventCompletion(r){const s=this.getCompletionState(r);return s.hasShownCard||s.cardDismissed}resetCompletionState(r){const s=this.completionTimers.get(r);s&&(clearTimeout(s),this.completionTimers.delete(r)),this.completionStates.delete(r)}getDebugInfo(r){const s=this.getCompletionState(r);return{state:s,hasPendingTimer:this.completionTimers.has(r),blockedTriggersCount:s.prematureTriggersBlocked.length}}clearAll(){this.completionTimers.forEach(r=>clearTimeout(r)),this.completionTimers.clear(),this.completionStates.clear()}}const Ut=new Zt;class Vt{STRIPE_TOOL_NAMES=["StripePaymentTool","stripe payment tool","stripe_payment","payment","checkout","stripe"];BLOCKCHAIN_TOOL_NAMES=["Blockchain Anchor Tool","blockchain anchor tool","blockchain_anchor","blockchain","anchor","chain"];CLARIFICATION_TOOL_NAMES=["ClarificationTool","clarification tool","clarification","question","ask"];MERGE_TOOL_NAMES=["merge fields tool","merge_fields","merge","order_tool","order tool","order"];PAYMENT_LINK_PATTERNS=[/https:\/\/checkout\.stripe\.com\/c\/pay\/[a-zA-Z0-9_-]+(?:#[a-zA-Z0-9%_\-=&+\/]*)?/g,/https:\/\/checkout\.stripe\.com\/pay\/[a-zA-Z0-9_-]+(?:#[a-zA-Z0-9%_\-=&+\/]*)?/g,/"payment_link":\s*"([^"]+)"/gi,/"payment_url":\s*"([^"]+)"/gi,/"checkout_url":\s*"([^"]+)"/gi,/payment[_\s]*link[:\s]*([^\s\n]+stripe[^\s\n]*)/gi];BLOCKCHAIN_HASH_PATTERNS=[/0x[a-fA-F0-9]{64}/g,/[a-fA-F0-9]{64}/g,/"tx_hash":\s*"([^"]+)"/gi,/"transaction_hash":\s*"([^"]+)"/gi,/"hash":\s*"([^"]+)"/gi];EMAIL_PATTERNS=[/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,/"email":\s*"([^"]+)"/gi,/"buyer_email":\s*"([^"]+)"/gi,/email[:\s]+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi];extractCompletionData(r){const s=r.steps,l=this.extractPaymentLink(s),n=this.extractBlockchainHash(s),m=this.extractBuyerEmail(s),f=this.extractOrderDetails(s);return{orderId:r.orderId||r.id,paymentLink:l,blockchainTxHash:n,buyerEmail:m,...f}}extractPaymentLink(r){const s=r.filter(l=>this.matchesToolNames(l,this.STRIPE_TOOL_NAMES));for(const l of s){const n=this.extractPaymentLinkFromOutput(l.output);if(n)return n}for(const l of r){const n=this.extractPaymentLinkFromOutput(l.output);if(n)return n}return null}extractBlockchainHash(r){const s=r.filter(l=>this.matchesToolNames(l,this.BLOCKCHAIN_TOOL_NAMES));for(const l of s){const n=this.extractBlockchainHashFromOutput(l.output);if(n)return n}for(const l of r){const n=this.extractBlockchainHashFromOutput(l.output);if(n)return n}return null}extractBuyerEmail(r){const s=["clarificationtool","clarification tool","clarification","orderextractiontool","order extraction","merge fields tool","merge_fields","validatortool","validator"],l=r.filter(n=>this.matchesToolNames(n,s));for(const n of l){const m=this.extractEmailFromOutput(n.output);if(m&&this.isValidEmail(m))return m}for(const n of r){const m=this.extractEmailFromOutput(n.output);if(m&&this.isValidEmail(m))return m}for(const n of r)if(n.output&&typeof n.output=="object"&&n.output.order_id){const f=n.output.order_id.split("-");for(const y of f)if(this.isValidEmail(y))return y}return"buyer@example.com"}extractOrderDetails(r){const s=["merge fields tool","merge_fields","merge","order_tool","order tool","order","orderextractiontool","order extraction","validatortool","validator","clarificationtool","clarification","financeandpaymenttool","finance"],l=r.filter(o=>this.matchesToolNames(o,s));let n="Unknown Model",m=1,f="Unknown Location",y="$0.00";for(const o of l){const c=this.extractOrderDetailsFromOutput(o.output);c.model!=="Unknown Model"&&(n=c.model),c.quantity!==1&&(m=c.quantity),c.deliveryLocation!=="Unknown Location"&&(f=c.deliveryLocation),c.totalAmount!=="$0.00"&&(y=c.totalAmount)}for(const o of r){const c=this.extractOrderDetailsFromOutput(o.output);if(n==="Unknown Model"&&c.model!=="Unknown Model"&&(n=c.model),m===1&&c.quantity!==1&&(m=c.quantity),f==="Unknown Location"&&c.deliveryLocation!=="Unknown Location"&&(f=c.deliveryLocation),y==="$0.00"&&c.totalAmount!=="$0.00"&&(y=c.totalAmount),n==="Unknown Model"){const b=`${o.name} ${o.toolName||""} ${JSON.stringify(o.output||"")}`.toLowerCase();b.includes("lamborghini")?n="Lamborghini Aventador":b.includes("ferrari")?n="Ferrari":b.includes("porsche")?n="Porsche":b.includes("bmw")?n="BMW":b.includes("mercedes")?n="Mercedes":b.includes("audi")&&(n="Audi")}if(f==="Unknown Location"){const b=`${o.name} ${o.toolName||""} ${JSON.stringify(o.output||"")}`.toLowerCase();b.includes("london")?f="London":b.includes("new york")?f="New York":b.includes("paris")?f="Paris":b.includes("tokyo")?f="Tokyo":b.includes("berlin")&&(f="Berlin")}}return{model:n,quantity:m,deliveryLocation:f,totalAmount:y}}matchesToolNames(r,s){const l=[r.toolName?.toLowerCase(),r.name?.toLowerCase(),r.id?.toLowerCase()].filter(Boolean);return s.some(n=>l.some(m=>m?.includes(n.toLowerCase())))}extractPaymentLinkFromOutput(r){if(!r)return null;if(typeof r=="object"&&r.payment_link)return r.payment_link;const s=typeof r=="string"?r:JSON.stringify(r);for(const l of this.PAYMENT_LINK_PATTERNS){l.lastIndex=0;const n=s.match(l);if(n&&n.length>0)for(const m of n){let f=m;if(m.includes('"payment_link":')){const y=m.match(/"payment_link":\s*"([^"]+)"/);y&&(f=y[1])}if(f=f.replace(/^[^h]*/,""),f.includes("checkout.stripe.com"))return f}}return null}extractBlockchainHashFromOutput(r){if(!r)return null;const s=typeof r=="string"?r:JSON.stringify(r);for(const l of this.BLOCKCHAIN_HASH_PATTERNS){const n=s.match(l);if(n&&n.length>0)for(const m of n){const f=m.replace(/^0x/,"");if(/^[a-fA-F0-9]{64}$/.test(f))return f.startsWith("0x")?f:`0x${f}`}}return null}extractEmailFromOutput(r){if(!r)return null;const s=typeof r=="string"?r:JSON.stringify(r),l=[...this.EMAIL_PATTERNS,/buyer_email['":\s]*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi,/"([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})"/gi,/for\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi,/to\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi];for(const n of l){n.lastIndex=0;const m=s.match(n);if(m&&m.length>0)for(const f of m){let y=f;if(f.includes(":")&&(y=f.split(":").pop()?.trim()||""),f.includes('"')){const g=f.match(/"([^"]+)"/);g&&(y=g[1])}if(f.includes(" ")){const g=f.match(/\s([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);g&&(y=g[1])}if(y=y.replace(/['",:;\s]/g,"").trim(),y&&this.isValidEmail(y))return y}}return null}extractOrderDetailsFromOutput(r){const s={model:"Unknown Model",quantity:1,deliveryLocation:"Unknown Location",totalAmount:"$0.00"};if(!r)return s;const l=typeof r=="string"?r:JSON.stringify(r);try{const n=typeof r=="object"?r:JSON.parse(l);return{model:n.model||n.product||n.item||n.buyer_email?.split("-")[1]||s.model,quantity:parseInt(n.quantity||n.qty||n.amount)||s.quantity,deliveryLocation:n.delivery_location||n.location||n.address||n.destination||n.buyer_email?.split("-")[2]||s.deliveryLocation,totalAmount:n.total_amount||n.total||n.price||n.cost||n.total_payable||s.totalAmount}}catch{let n=this.extractOrderField(l,[/(?:model|product|item)[:\s]+([^,\n]+)/i,/(Lamborghini\s+Aventador)(?:\s+for|\s+to|,|\.|\s*$)/i,/(Ferrari\s+[A-Za-z0-9]+)(?:\s+for|\s+to|,|\.|\s*$)/i,/(Porsche\s+[A-Za-z0-9]+)(?:\s+for|\s+to|,|\.|\s*$)/i,/(BMW\s+[A-Za-z0-9]+)(?:\s+for|\s+to|,|\.|\s*$)/i,/(Mercedes\s+[A-Za-z0-9\s]+)(?:\s+for|\s+to|,|\.|\s*$)/i,/(Audi\s+[A-Za-z0-9\s]+)(?:\s+for|\s+to|,|\.|\s*$)/i,/Order\s+placed:\s*\d+x?\s*([^,\s]+(?:\s+[^,\s]+)*?)(?:\s+for|\s+to|,)/i,/(\d+x?\s*[A-Z][a-zA-Z\s]+(?:Aventador|Ferrari|Porsche|BMW|Mercedes|Audi))(?:\s+for|\s+to|,)/i])||s.model;const m=this.extractWithPattern(l,[/quantity[:\s]+(\d+)/i,/qty[:\s]+(\d+)/i,/(\d+)\s*x\s*[A-Z]/i,/(\d+)\s+units?/i,/Order\s+placed:\s*(\d+)x/i]),f=m?parseInt(m):s.quantity;let y=this.extractOrderField(l,[/(?:delivery[_\s]*location|location|delivering?\s+(?:to|in))[:\s]+([^,\n]+)/i,/to\s+([A-Z][a-zA-Z\s]+)(?:\.|,|$)/i,/in\s+([A-Z][a-zA-Z\s]+)(?:\.|,|$)/i,/(London|New York|Paris|Tokyo|Berlin|Los Angeles|Chicago|Miami)/i])||s.deliveryLocation,g=this.extractOrderField(l,[/(?:total[_\s]*(?:amount|payable|cost)|total|price|cost)[:\s]+([A-Z]{3}\s*[\d,]+(?:\.\d{2})?)/i,/(\$[\d,]+(?:\.\d{2})?)/i,/(USD\s*[\d,]+(?:\.\d{2})?)/i,/(EUR\s*[\d,]+(?:\.\d{2})?)/i])||s.totalAmount;return n&&n!==s.model&&(n=n.replace(/^\d+x?\s*/,"").trim(),n=n.replace(/\s+for\s+[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}.*$/,"").trim(),n=n.replace(/\s+to\s+[A-Z][a-zA-Z\s]+$/,"").trim(),n=n.replace(/[,.]$/,"").trim()),y&&y!==s.deliveryLocation&&(y=y.replace(/[.,]$/,"").trim()),{model:n,quantity:f,deliveryLocation:y,totalAmount:g}}}extractWithPattern(r,s){for(const l of s){l.lastIndex=0;const n=l.exec(r);if(n&&n[1])return n[1].trim()}return null}extractOrderField(r,s){for(const l of s){l.lastIndex=0;const n=l.exec(r);if(n&&n[1])return n[1].trim()}return null}isValidEmail(r){return/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(r)}}const ie=new Vt;function Yt(){const d={clarification_id:"test-clarification-"+Date.now(),question:"Test clarification: Do you want to proceed with the order?",options:["Yes, proceed","No, cancel","Modify order"],timeout_seconds:300,required:!0};return window.dispatchEvent(new CustomEvent("test-clarification",{detail:d})),d}typeof window<"u"&&(window.testClarificationRequest=Yt);const Ce=[{id:"planning",name:"Planning",status:"pending",logs:[],progress:0},{id:"validation",name:"Order Validation",status:"pending",logs:[],progress:0},{id:"inventory",name:"Inventory Check",status:"pending",logs:[],progress:0},{id:"pricing",name:"Price Calculation",status:"pending",logs:[],progress:0},{id:"supplier",name:"Supplier Quotes",status:"pending",logs:[],progress:0},{id:"logistics",name:"Logistics Planning",status:"pending",logs:[],progress:0},{id:"finance",name:"Finance Terms",status:"pending",logs:[],progress:0},{id:"confirmation",name:"User Confirmation",status:"pending",logs:[],progress:0},{id:"payment",name:"Payment Processing",status:"pending",logs:[],progress:0},{id:"order",name:"Order Finalization",status:"pending",logs:[],progress:0},{id:"blockchain",name:"Blockchain Recording",status:"pending",logs:[],progress:0},{id:"email",name:"Email Confirmation",status:"pending",logs:[],progress:0}],ta=()=>{const[d,r]=v.useState(""),[s,l]=v.useState(!1),[n,m]=v.useState(null),[f,y]=v.useState(0),[g,o]=v.useState(null),[c,b]=v.useState(!1),[F,R]=v.useState(!1);v.useEffect(()=>{},[s]),v.useEffect(()=>{},[n]);const A=v.useRef(null),N=v.useRef(!0);v.useRef(null);const[k,P]=At(),Q=Pt(),{state:I,selectWorkflowRun:H,markCompletionCardShown:Z,markCompletionCardDismissed:X}=Ie(),J=k.get("orderId"),_=k.get("runId");v.useEffect(()=>()=>{N.current=!1,A.current&&clearTimeout(A.current)},[]),v.useEffect(()=>{try{It.clearPersistedState()}catch{}},[]),v.useEffect(()=>{const a=t=>{o("An unexpected error occurred in the workflow.")};return window.addEventListener("error",a),()=>window.removeEventListener("error",a)},[]);const Y=v.useCallback(a=>{R(!0),r(a),setTimeout(()=>{R(!1)},300)},[]),K=v.useMemo(()=>Object.values(I.workflow.activeRuns),[I.workflow.activeRuns]),x=v.useMemo(()=>{if(_&&I.workflow.activeRuns[_])return I.workflow.activeRuns[_];if(I.workflow.selectedRun&&I.workflow.activeRuns[I.workflow.selectedRun])return I.workflow.activeRuns[I.workflow.selectedRun];if(J){const t=K.find(i=>i.orderId===J);if(t)return t}const a=K.sort((t,i)=>new Date(i.startTime).getTime()-new Date(t.startTime).getTime());return a.length>0?a[0]:null},[I.workflow.activeRuns,I.workflow.selectedRun,J,_,K]);v.useCallback(()=>{o(null),b(!0),setTimeout(()=>{b(!1)},1e3)},[]),v.useEffect(()=>(performance.now(),()=>{performance.now()}));const D=v.useMemo(()=>{try{if(!x?.steps||x.steps.length===0)return Ce;const a=x.steps.filter(t=>{const i=t.id.includes("_internal")||t.id.includes("_system")||t.id.includes("_temp")||t.name?.includes("[Internal]")||t.name?.includes("[System]"),h=t.status==="failed"&&x.steps.some(C=>C.id!==t.id&&C.toolName===t.toolName&&C.status==="completed"),w=i||h;return!w});return a.length===0?Ce:a}catch(a){return o(`Failed to process workflow steps: ${a instanceof Error?a.message:String(a)}`),Ce}},[x?.steps,x?.status,x?.id]);v.useEffect(()=>{},[x?.id,D]),v.useEffect(()=>{if(x&&D.length>0){const a=D.find(w=>w.status==="active"),t=D.find(w=>w.status==="pending"||w.status==="active"),i=D[0],h=a?.id||t?.id||i?.id||"";h&&h!==d&&r(h)}else x||r("")},[x,D,d]);const ne=v.useMemo(()=>{try{const a=[],t=new Set;return D.forEach(i=>{i.logs&&Array.isArray(i.logs)&&i.logs.forEach(h=>{const w=`${h.timestamp}-${h.message}`;t.has(w)||(t.add(w),a.push({...h,metadata:{...h.metadata,stepId:i.id,stepName:i.name}}))})}),I.workflow.logStream&&Array.isArray(I.workflow.logStream)&&I.workflow.logStream.forEach(i=>{const h=`${i.timestamp}-${i.message}`;t.has(h)||(t.add(h),a.push(i))}),a.sort((i,h)=>{try{return new Date(i.timestamp).getTime()-new Date(h.timestamp).getTime()}catch{return 0}})}catch{return[]}},[D,I.workflow.logStream]),de=v.useMemo(()=>ne.filter(a=>a.metadata?.type==="clarification_request"||a.metadata?.type==="clarification_response"),[ne]),B=v.useMemo(()=>{if(x)return{completed:x.completedSteps,total:x.totalSteps||D.length,percentage:x.progress,status:x.status,startTime:x.startTime,endTime:x.endTime,currentStep:x.currentStep};const a=D.filter(h=>h.status==="completed").length,t=D.length,i=D.find(h=>h.status==="active");return{completed:a,total:t,percentage:t>0?a/t*100:0,status:"pending",startTime:void 0,endTime:void 0,currentStep:i?.id}},[x,D]),oe=v.useMemo(()=>{if(!B.startTime)return null;const a=new Date(B.startTime),i=(B.endTime?new Date(B.endTime):new Date).getTime()-a.getTime(),h=Math.floor(i/6e4),w=Math.floor(i%6e4/1e3);return`${h}:${w.toString().padStart(2,"0")}`},[B.startTime,B.endTime]);v.useEffect(()=>{const a=t=>{if(t.type==="email_sent"||t.type==="email_completed"){let i;try{if(x)i=ie.extractCompletionData(x);else throw new Error("No current workflow run")}catch{i={orderId:t.orderId||"BACKEND-EMAIL-"+Date.now(),model:t.model||"Order Processing Complete",quantity:t.quantity||1,deliveryLocation:t.deliveryLocation||"Processing Complete",totalAmount:t.totalAmount||"See workflow details",paymentLink:t.paymentLink||"",blockchainTxHash:t.blockchainTxHash||"",buyerEmail:t.buyerEmail||"See workflow logs"}}m(i),l(!0)}};return typeof window<"u"&&(window.handleEmailCompletionEvent=a,window.triggerEmailCompletion=t=>{const i={type:"email_completed",orderId:"TEST-ORDER-"+Date.now(),buyerEmail:"test@example.com",model:"Test Order",quantity:1,deliveryLocation:"Test Location",totalAmount:"$100.00",paymentLink:"https://checkout.stripe.com/pay/test123",blockchainTxHash:"0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"};a(t||i)}),()=>{typeof window<"u"&&(delete window.handleEmailCompletionEvent,delete window.triggerEmailCompletion)}},[x,ie]),v.useEffect(()=>{if(!(!x||!N.current)){x.id;try{if(s)return;if(x.steps?.find(u=>(u.toolName==="Portia Google Send Email Tool"||u.toolName?.toLowerCase().includes("email")||u.toolName?.toLowerCase().includes("gmail")||u.toolName?.toLowerCase().includes("send_email")||u.name?.toLowerCase().includes("email")||u.name?.toLowerCase().includes("send email")||u.id?.toLowerCase().includes("email"))&&u.status==="completed")){let u;try{u=ie.extractCompletionData(x)}catch{u={orderId:x.orderId||"EMAIL-COMPLETED-"+Date.now(),model:"Order Processing Complete",quantity:1,deliveryLocation:"Processing Complete",totalAmount:"See workflow details",paymentLink:"",blockchainTxHash:"",buyerEmail:"See workflow logs"}}m(u),l(!0);return}if(x.steps?.find(u=>{if(u.status!=="completed"||!u.output)return!1;const L=typeof u.output=="string"?u.output:JSON.stringify(u.output);return[/Sent email with id/i,/Email sent successfully/i,/Message sent with ID/i,/Email delivered/i,/Successfully sent email/i,/email.*sent/i,/confirmation.*sent/i].some($=>$.test(L))})){let u;try{u=ie.extractCompletionData(x)}catch{u={orderId:x.orderId||"EMAIL-CONFIRMED-"+Date.now(),model:"Order Processing Complete",quantity:1,deliveryLocation:"Processing Complete",totalAmount:"See workflow details",paymentLink:"",blockchainTxHash:"",buyerEmail:"See workflow logs"}}m(u),l(!0);return}const i=x.steps?.filter(u=>u.status==="completed")||[],h=x.steps?.length||0,w=h>0?i.length/h:0,C=i.some(u=>u.toolName?.toLowerCase().includes("stripe")||u.toolName?.toLowerCase().includes("payment")||u.name?.toLowerCase().includes("payment")),S=i.some(u=>u.toolName?.toLowerCase().includes("blockchain")||u.toolName?.toLowerCase().includes("anchor")||u.name?.toLowerCase().includes("blockchain")),j=i.some(u=>u.toolName?.toLowerCase().includes("order")||u.name?.toLowerCase().includes("order"));if(x.status==="completed"&&h>=3||w>=.7&&(C||S)||C&&S||C&&j&&i.length>=5||x.status==="completed"&&i.length>=2){let u;try{u=ie.extractCompletionData(x)}catch{u={orderId:x.orderId||"WORKFLOW-COMPLETED-"+Date.now(),model:"Order Processing Complete",quantity:1,deliveryLocation:"Processing Complete",totalAmount:"See workflow details",paymentLink:"",blockchainTxHash:"",buyerEmail:"See workflow logs"}}m(u),l(!0);return}if(i.length>=3&&i.some(L=>{const E=`${L.name} ${L.toolName||""} ${JSON.stringify(L.output||"")}`.toLowerCase();return E.includes("final")||E.includes("complete")||E.includes("success")||E.includes("payment")||E.includes("order")||E.includes("blockchain")||E.includes("email")||E.includes("confirmation")})){let L;try{L=ie.extractCompletionData(x)}catch{L={orderId:x.orderId||"ULTRA-FALLBACK-"+Date.now(),model:"Order Processing Complete",quantity:1,deliveryLocation:"Processing Complete",totalAmount:"See workflow details",paymentLink:"",blockchainTxHash:"",buyerEmail:"See workflow logs"}}m(L),l(!0);return}if(y(u=>u+1),f>=3&&i.length>=2){let u;try{u=ie.extractCompletionData(x)}catch{u={orderId:x.orderId||"TIME-FALLBACK-"+Date.now(),model:"Order Processing Complete",quantity:1,deliveryLocation:"Processing Complete",totalAmount:"See workflow details",paymentLink:"",blockchainTxHash:"",buyerEmail:"See workflow logs"}}m(u),l(!0);return}}catch{}return()=>{A.current&&clearTimeout(A.current)}}},[x?.id,x?.status,x?.steps,s]);const p=v.useCallback(()=>{x&&(X(x.id),Ut.markCompletionCardDismissed(x.id)),l(!1),setTimeout(()=>{N.current&&m(null)},500)},[x,X]),W=v.useCallback(a=>{H(a),P(t=>{const i=new URLSearchParams(t);return i.set("runId",a),i})},[H,P]),U={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.5,ease:"easeOut"}}};return v.useEffect(()=>{window.debugWorkflowState=()=>{},window.checkEmailCompletion=()=>x?(x.steps?.filter(t=>t.toolName?.includes("Email")||t.name?.includes("Email")||t.toolName==="Portia Google Send Email Tool"),x.steps?.some(t=>{try{if(!t.output)return!1;const i=String(t.output);return i.includes("Sent email with id:")||i.includes("198e4106513e231c")||t.toolName==="Portia Google Send Email Tool"&&t.status==="completed"}catch{return!1}})||!1):void 0,window.triggerEmailCompletion=()=>{if(!x)return;const a=x.steps?.find(t=>t.toolName==="Portia Google Send Email Tool"||t.toolName?.toLowerCase().includes("email"));if(a){if(a.status==="completed")try{const t=ie.extractCompletionData(x);m(t),l(!0)}catch{window.forceShowCompletionCard()}}else window.forceShowCompletionCard()}},[x,s,n,D]),g?e.jsx("div",{className:"p-6 max-w-4xl mx-auto",children:e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-red-800 dark:text-red-200 mb-2",children:"Workflow Error"}),e.jsx("p",{className:"text-red-600 dark:text-red-300 mb-4",children:g}),e.jsx("button",{onClick:()=>{o(null),window.location.reload()},className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors",children:"Reload Page"})]})}):e.jsxs(M.div,{className:"p-6 max-w-4xl mx-auto",variants:U,initial:"hidden",animate:"visible",role:"main","aria-label":"Workflow visualization page",children:[K.length>1&&e.jsx("div",{className:"mb-6 p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"text-sm font-medium",id:"workflow-runs-label",children:"Active Workflow Runs"}),e.jsxs(z,{variant:"outline","aria-label":`${K.length} active workflow runs`,children:[K.length," active"]})]}),e.jsxs(wt,{value:x?.id||"",onValueChange:W,"aria-labelledby":"workflow-runs-label",children:[e.jsx(kt,{className:"w-64","aria-label":"Select workflow run",children:e.jsx(jt,{placeholder:"Select workflow run"})}),e.jsx(Nt,{children:K.map(a=>e.jsx(Ct,{value:a.id,"aria-label":`Workflow run ${a.orderId} - ${a.status}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:a.status==="running"?"default":"secondary",className:"text-xs","aria-label":`Status: ${a.status}`,children:a.status}),e.jsx("span",{children:a.orderId}),e.jsxs("span",{className:"text-xs text-slate-500",children:["(",new Date(a.startTime).toLocaleTimeString(),")"]})]})},a.id))})]})]})}),e.jsxs("div",{className:"mb-8 p-6 bg-gradient-to-r from-sky-500/10 via-cyan-400/5 to-fuchsia-500/10 rounded-2xl border border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Order Processing Pipeline"}),x&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:B.status==="running"?"default":B.status==="completed"?"secondary":"outline",children:x.orderId}),e.jsx(z,{variant:"outline",className:"text-xs",children:B.status})]}),!x&&e.jsx(z,{variant:"outline",children:"No active workflow"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-600 dark:text-slate-300",children:[e.jsxs("span",{children:["Progress: ",B.completed,"/",B.total," ","steps"]}),oe&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Elapsed: ",oe]})]}),B.startTime&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Started:"," ",new Date(B.startTime).toLocaleTimeString()]})]})]})]}),e.jsx("div",{className:"w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2",children:e.jsx(M.div,{className:"bg-gradient-to-r from-blue-500 to-emerald-500 h-2 rounded-full",initial:{width:0},animate:{width:`${B.percentage}%`},transition:{duration:1,ease:"easeOut"}})})]}),!x&&K.length===0&&e.jsxs("div",{className:"mb-8 p-8 text-center bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Active Workflows"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300 mb-4",children:"Start processing an order to see the workflow visualization here."}),e.jsx(V,{onClick:()=>Q("/orders"),variant:"outline","aria-label":"Navigate to orders page to start a new workflow",children:"Go to Orders"})]}),c&&e.jsxs("div",{className:"mb-8 p-8 text-center bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300",children:"Loading workflow data..."})]}),e.jsx(Dt,{clarificationLogs:de,className:"mb-6",onDismiss:a=>{}}),e.jsxs(St,{defaultValue:"current",className:"space-y-6",children:[e.jsxs(Tt,{className:"grid w-full grid-cols-3",children:[e.jsx(ve,{value:"current",children:"Current Workflow"}),e.jsx(ve,{value:"logs",children:"Live Logs"}),e.jsx(ve,{value:"demo",children:"Interactive Demo"})]}),e.jsxs(we,{value:"current",className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Current Pipeline Steps"}),x&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300",children:[e.jsxs("span",{children:["Run ID: ",x.id]}),B.currentStep&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Current: ",B.currentStep]})]})]})]}),D.length>0?e.jsx("div",{className:`transition-opacity duration-300 ${F?"opacity-75":"opacity-100"}`,children:e.jsx(Oe,{steps:D,currentStep:d,onStepClick:Y,orientation:"vertical","aria-label":"Workflow steps visualization",className:"workflow-stepper"})}):e.jsxs("div",{className:"p-8 text-center bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Loading Workflow Steps"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300 mb-4",children:x?"Processing workflow steps...":"Waiting for workflow to start..."}),e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"})]})]}),e.jsxs(we,{value:"logs",className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Workflow Log Stream"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300 mb-4",children:"Real-time log stream showing all workflow step activities and system events."}),e.jsx(Xe,{logs:ne,title:"Workflow Processing Logs",maxHeight:600,autoScroll:!0,filterable:!0,searchable:!0,virtualized:!0,showControls:!0,onLogClick:a=>{},"aria-label":"Real-time workflow processing logs",className:"workflow-logs"})]}),e.jsxs(we,{value:"demo",className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Interactive Workflow Demo"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300 mb-4",children:"Experience how the workflow stepper animates and updates in real-time during order processing."}),!1,!1,e.jsx($t,{}),e.jsx(Bt,{}),e.jsx(zt,{}),e.jsx(Rt,{})]})]}),n&&e.jsx(Ht,{onClose:p,fallbackData:{orderId:n.orderId,buyerEmail:n.buyerEmail,paymentLink:n.paymentLink,blockchainTxHash:n.blockchainTxHash},children:e.jsx(qt,{isVisible:s,onClose:p,orderData:n,"aria-label":"Order completion notification"})})]})};export{ta as default};
